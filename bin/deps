#!/usr/bin/env node

process.title = 'lint-deps';

const inquirer = require('inquirer');
const wrap = require('word-wrap');
const log = require('verbalize');
const _ = require('lodash');

const exec = require('../lib/exec');
const question = require('../lib/question');
const generateCommand = require('../lib/answers');
const filter = require('../lib/filter');
const prompt = require('../lib/prompt');
const deps = require('../');

// Diffs
var notRequired = _.difference(deps.allDeps, deps.allReq);
var missingDeps = _.difference(deps.allReq, deps.allDeps);
missingDeps = filter(missingDeps, ['handlebars-helper']);

// Prompts
function unusedPackages() {
  console.log();
  console.log(log.bold(wrap(notRequired.length + ' unused packages found: ')) + '\'' + notRequired.join('\', \'') + '\'');
  console.log();
  console.log(log.gray(wrap('This tool doesn\'t remove dependencies, you\'ll have to do that manually.')));
  console.log('  ---');
}

function missingPackages() {
  console.log();
  log.error('  ' + missingDeps.length + ' missing packages found:', wrap('\'' + missingDeps.join('\', \'') + '\''));
  console.log();
}

if(notRequired.length > 0) {
  unusedPackages();
}

if(missingDeps.length === 0) {
  log.success('  All packages appear to be listed. OK!');
} else {
  missingPackages();
  var prompts = [];

  prompts.push({
    type: "confirm",
    name: 'install',
    message: log.bold('Want to install and add to package.json?'),
    default: false
  });

  // Generate questions based on missing deps.
  prompts = prompts.concat(question(missingDeps));

  function run(done) {
    prompt(prompts, function (answers) {
      if(answers.install === true) {

        // Generate answers based on missing deps.
        exec(generateCommand(answers), function (err, cb) {
          if (err) {cb(log.error(err));}
          done();
        }.bind(this));

      } else {
        log.success('\n  Got it. All is good.');
        process.exit(0);
      }
    }.bind(this));
  }

  run(function(err) {
    if(err) {
      log.error(err);
      process.exit(1);
    }
  });
}